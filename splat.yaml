metadata:
   name: lava-deploy
   maintainer:
      - Michael Hudson-Doyle <michael.hudson@linaro.org>
   format: "Lava-Test-Shell Test Definition 1.0"
   version: 1.0
   description: ""
   os:
      - ubuntu
   devices:
      - mustang
   environment:
      - lava-test-shell


run:
  steps:
    - "set -x"
    - "wget --progress=dot -e dotbytes=10M -O- http://lava-leg02/~mwhudson/trusty-server-cloudimg-arm64-disk1.raw.img | dd of=/dev/sda bs=1M"
    - "sync"
    - "echo 1 > /sys/class/block/sda/device/rescan"
    - "mount /dev/sda1 /mnt"
    - "mv /mnt/etc/resolv.conf /mnt/etc/resolv.conf.bak"
    - "cp /etc/resolv.conf /mnt/etc/resolv.conf"
    - "mount -t proc procfs /mnt/proc"
    - "SDA1UUID=`ls /dev/disk/by-uuid`"
    - "sed -e 's/@SDA1UUID@/'${SDA1UUID}'/' boot.script > /mnt/boot/boot.script"
    - "cat /mnt/boot/boot.script"
    - "cp fk.sh /mnt/fk.sh"
    - "chroot /mnt bash -x /fk.sh"
    - "rm /mnt/fk.sh"
    - "cp do-tempest.sh /mnt/bin/do-tempest.sh"
    - "chmod a+x /mnt/bin/do-tempest.sh"
    - "mv /mnt/etc/resolv.conf.bak /mnt/etc/resolv.conf"
    - "mkdir -p /mnt/var/lib/cloud/seed/nocloud"
    - "cp -a cloud-seed/* /mnt/var/lib/cloud/seed/nocloud/"
    - "cd"
    - "sync"
    - "sleep 1"
    - "umount /mnt"
    - "sync"

