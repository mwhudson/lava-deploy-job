device_type: mustang
job_name: mwhudson-devstack
timeout: 24000

actions:

  - &deploy-nfs
    command: deploy_linaro_kernel
    parameters:
      dtb: 'http://images-internal/mustang/mustang.dtb_1.11'
      kernel: 'http://images-internal/mustang/uImage_1.11'
      login_prompt: 'login:'
      nfsrootfs: 'http://lava-leg02/~mwhudson/debian-arm64-chroot.tar.bz2'
      password: linaro
      password_prompt: Password
      target_type: ubuntu
      username: root

  - &boot-nfs
    command: boot_linaro_image
    parameters:
      boot_cmds:
        - 'setenv autoload no'
        - 'setenv kernel_addr_r ''{KERNEL_ADDR}'''
        - 'setenv initrd_addr_r ''{RAMDISK_ADDR}'''
        - 'setenv fdt_addr_r ''{DTB_ADDR}'''
        - 'setenv loadkernel ''tftp ${kernel_addr_r} {KERNEL}'''
        - 'setenv loadinitrd ''tftp ${initrd_addr_r} {RAMDISK}'''
        - 'setenv loadfdt ''tftp ${fdt_addr_r} {DTB}'''
        - 'setenv nfsargs ''setenv bootargs root=/dev/nfs rw nfsroot={SERVER_IP}:{NFSROOTFS} panic=1 console=ttyS0,115200 earlyprintk=uart8250-32bit,0x1c020000 debug ip=dhcp'''
        - 'setenv bootcmd ''dhcp; setenv serverip {SERVER_IP}; run loadkernel; run loadinitrd; run loadfdt; run nfsargs; {BOOTX}'''
        - 'boot'
      test_image_prompt: root@sid

  - command: lava_test_shell
    parameters:
      testdef_repos:
        - git-repo: http://github.com/mwhudson/lava-deploy-job
          parameters:
            LAVA_CUSTOM_KERNEL_VERSION: ''
            LAVA_RUN_TEMPEST: 'yes'
            LAVA_SLEEP_FOR_ACCESS: 'no'
            LAVA_TESTS_TO_RUN: ''
          testdef: splat.yaml
      timeout: 900

  - &deploy-sata
    command: deploy_linaro_kernel
    parameters:
      dtb: http://images-internal/mustang/mustang.dtb_1.11
      kernel: http://images-internal/mustang/uImage_1.11
      login_commands:
        - 'sleep 60; sudo -s'
      login_prompt: 'login:'
      password: password
      password_prompt: Password
      target_type: ubuntu
      username: ubuntu

  - &boot-sata
    command: boot_linaro_image
    parameters:
      boot_cmds:
        - 'setenv script_addr_r 0x4004000000'
        - 'scsi init'
        - 'ext4load scsi 0 ${script_addr_r} boot/boot.scr'
        - 'source ${script_addr_r}'

  - command: lava_command_run
    parameters:
      commands:
        - '/opt/lava-scripts/upgrade-kernel.sh'
      timeout: 24000

  - *deploy-sata
  - *boot-sata

  - command: lava_command_run
    parameters:
      commands:
        - '/opt/lava-scripts/do-tempest.sh'
      timeout: 24000

  - *deploy-nfs
  - *boot-nfs

  - command: lava_test_shell
    parameters:
      testdef_repos:
      - git-repo: 'http://github.com/mwhudson/lava-deploy-job'
        testdef: process-results.yaml
      timeout: 900

  - command: submit_results
    parameters:
      server: 'http://validation.linaro.org/RPC2/'
      stream: '/private/team/mustang/mwhudson/'
