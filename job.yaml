device_type: mustang
job_name: mwhudson-devstack
timeout: 30000

actions:

  - &deploy-nfs
    command: deploy_linaro_kernel
    parameters:
      dtb: 'http://lava-leg02/~mwhudson/mustang.dtb'
      kernel: 'http://lava-leg02/~mwhudson/uImage'
      ramdisk: 'http://lava-leg02/~mwhudson/uInitrd-nfs'
      nfsrootfs: 'http://lava-leg02/~mwhudson/ubuntu-arm64-chroot.tar.bz2'
      target_type: ubuntu

  - &boot-nfs
    command: boot_linaro_image
    parameters:
      boot_cmds:
        - 'setenv autoload no'
        - 'setenv kernel_addr_r ''{KERNEL_ADDR}'''
        - 'setenv initrd_addr_r ''{RAMDISK_ADDR}'''
        - 'setenv fdt_addr_r ''{DTB_ADDR}'''
        - 'setenv loadstuff ''tftp ${kernel_addr_r} {KERNEL}; tftp ${initrd_addr_r} {RAMDISK}; tftp ${fdt_addr_r} {DTB}'''
        - 'setenv bootargs console=ttyS0,115200 panic root=/dev/nfs rw nfsroot={SERVER_IP}:{NFSROOTFS} ip=dhcp'
        - 'setenv bootcmd ''dhcp; setenv serverip {SERVER_IP}; run loadstuff; {BOOTX}'''
        - 'boot'

  - command: lava_test_shell
    parameters:
      testdef_repos:
        - git-repo: http://github.com/mwhudson/lava-deploy-job
          parameters:
            LAVA_CUSTOM_KERNEL_VERSION: ''
            LAVA_RUN_TEMPEST: 'yes'
            LAVA_SLEEP_FOR_ACCESS: 'no'
            LAVA_TESTS_TO_RUN: ''
          testdef: splat.yaml
      timeout: 900

  # - &deploy-sata
  #   command: deploy_linaro_kernel
  #   parameters:
  #     dtb: http://images-internal/mustang/mustang.dtb_1.11
  #     kernel: http://images-internal/mustang/uImage_1.11
  #     login_commands:
  #       - 'sleep 60; sudo -s'
  #     login_prompt: 'login:'
  #     password: password
  #     password_prompt: Password
  #     target_type: ubuntu
  #     username: ubuntu

  # - &boot-sata
  #   command: boot_linaro_image
  #   parameters:
  #     boot_cmds:
  #       - 'setenv script_addr_r 0x4004000000'
  #       - 'scsi init'
  #       - 'ext4load scsi 0 ${script_addr_r} boot/boot.scr'
  #       - 'source ${script_addr_r}'

  # - command: lava_command_run
  #   parameters:
  #     commands:
  #       - '/opt/lava-scripts/upgrade-kernel.sh'
  #     timeout: 24000

  # - *deploy-sata
  # - *boot-sata

  # - command: lava_command_run
  #   parameters:
  #     commands:
  #       - '/opt/lava-scripts/do-tempest.sh'
  #     timeout: 24000

  # - *deploy-nfs
  # - *boot-nfs

  # - command: lava_test_shell
  #   parameters:
  #     testdef_repos:
  #     - git-repo: 'http://github.com/mwhudson/lava-deploy-job'
  #       testdef: process-results.yaml
  #     timeout: 1800

  # - command: submit_results
  #   parameters:
  #     server: 'http://validation.linaro.org/RPC2/'
  #     stream: '/private/team/mustang/mwhudson/'
